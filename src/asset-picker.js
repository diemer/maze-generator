// Asset list for tile picker
const TILE_ASSETS = [
  'src/assets/isobricks.png',
  'src/assets/isobricks2.png',
  'src/assets/isobricks3.png',
  'src/assets/isobricks4.png',
  'src/assets/isobrickswall.png',
  'src/assets/isobrickswall2.png',
  'src/assets/isobrickswall3.png',
  'src/assets/isobrickswall4.png',
  'src/assets/isocube.png',
  'src/assets/Isowoodtexture.png',
  'src/assets/Isowoodtexture2.png',
  'src/assets/isorock.png',
  'src/assets/isorock2.png',
  'src/assets/IsoPillar.png',
  'src/assets/IsoPillar2.png',
  'src/assets/isosquare-pillar1.png',
  'src/assets/ISOARCH.png',
  'src/assets/ISOARCH2.png',
  'src/assets/ISOARCHporticullis.png',
  'src/assets/isoDoorWood1.png',
  'src/assets/isoDoorWood2.png',
  'src/assets/isowindow.png',
  'src/assets/isowindow2.png',
  'src/assets/isostair.png',
  'src/assets/isostair2.png',
  'src/assets/isostair3.png',
  'src/assets/isostair4.png',
  'src/assets/isoslope.png',
  'src/assets/isoslope2.png',
  'src/assets/isoslopeback.png',
  'src/assets/isoslopeback2.png',
  'src/assets/isoladder.png',
  'src/assets/isoladder2.png',
  'src/assets/Iso-Pit.png',
  'src/assets/isotree.png',
  'src/assets/isobush.png',
  'src/assets/isowalltorch.png',
  'src/assets/isowalltorch2.png',
  'src/assets/isocandle.png',
  'src/assets/isocandlelit.png',
  'src/assets/isobanner.png',
  'src/assets/isobanner2.png',
  'src/assets/IsoTableRound.png',
  'src/assets/IsoTableSquare.png',
  'src/assets/IsoChair1.png',
  'src/assets/IsoChair2.png',
  'src/assets/IsoChair3.png',
  'src/assets/IsoChair4.png',
  'src/assets/isobed.png',
  'src/assets/isobed2.png',
  'src/assets/isobed3.png',
  'src/assets/isobed4.png',
  'src/assets/isobookcase.png',
  'src/assets/isobookcase2.png',
  'src/assets/isobookcase-back.png',
  'src/assets/isobookcase-back2.png',
  'src/assets/isoempty-bookcase.png',
  'src/assets/isoempty-bookcase2.png',
  'src/assets/isobook.png',
  'src/assets/IsoBarrel.png',
  'src/assets/isoChest.png',
  'src/assets/isoChest2.png',
  'src/assets/isocrate.png',
  'src/assets/isogold.png',
  'src/assets/isoRug.png',
  'src/assets/isoRug2.png',
  'src/assets/isobones.png',
  'src/assets/isobones2.png',
  'src/assets/isolever.png',
  'src/assets/isolever2.png',
  // Tileset tiles
  'src/assets/tile_000.png',
  'src/assets/tile_001.png',
  'src/assets/tile_002.png',
  'src/assets/tile_003.png',
  'src/assets/tile_004.png',
  'src/assets/tile_005.png',
  'src/assets/tile_006.png',
  'src/assets/tile_007.png',
  'src/assets/tile_008.png',
  'src/assets/tile_009.png',
  'src/assets/tile_010.png',
  'src/assets/tile_011.png',
  'src/assets/tile_012.png',
  'src/assets/tile_013.png',
  'src/assets/tile_014.png',
  'src/assets/tile_015.png',
  'src/assets/tile_016.png',
  'src/assets/tile_017.png',
  'src/assets/tile_018.png',
  'src/assets/tile_019.png',
  'src/assets/tile_020.png',
  'src/assets/tile_021.png',
  'src/assets/tile_022.png',
  'src/assets/tile_023.png',
  'src/assets/tile_024.png',
  'src/assets/tile_025.png',
  'src/assets/tile_026.png',
  'src/assets/tile_027.png',
  'src/assets/tile_028.png',
  'src/assets/tile_029.png',
  'src/assets/tile_030.png',
  'src/assets/tile_031.png',
  'src/assets/tile_032.png',
  'src/assets/tile_033.png',
  'src/assets/tile_034.png',
  'src/assets/tile_035.png',
  'src/assets/tile_036.png',
  'src/assets/tile_037.png',
  'src/assets/tile_038.png',
  'src/assets/tile_039.png',
  'src/assets/tile_040.png',
  'src/assets/tile_041.png',
  'src/assets/tile_042.png',
  'src/assets/tile_043.png',
  'src/assets/tile_044.png',
  'src/assets/tile_045.png',
  'src/assets/tile_046.png',
  'src/assets/tile_047.png',
  'src/assets/tile_048.png',
  'src/assets/tile_049.png',
  'src/assets/tile_050.png',
  'src/assets/tile_051.png',
  'src/assets/tile_052.png',
  'src/assets/tile_053.png',
  'src/assets/tile_054.png',
  'src/assets/tile_055.png',
  'src/assets/tile_056.png',
  'src/assets/tile_057.png',
  'src/assets/tile_058.png',
  'src/assets/tile_059.png',
  'src/assets/tile_060.png',
  'src/assets/tile_061.png',
  'src/assets/tile_062.png',
  'src/assets/tile_063.png',
  'src/assets/tile_064.png',
  'src/assets/tile_065.png',
  'src/assets/tile_066.png',
  'src/assets/tile_067.png',
  'src/assets/tile_068.png',
  'src/assets/tile_069.png',
  'src/assets/tile_070.png',
  'src/assets/tile_071.png',
  'src/assets/tile_072.png',
  'src/assets/tile_073.png',
  'src/assets/tile_074.png',
  'src/assets/tile_075.png',
  'src/assets/tile_076.png',
  'src/assets/tile_077.png',
  'src/assets/tile_078.png',
  'src/assets/tile_079.png',
  'src/assets/tile_080.png',
  'src/assets/tile_081.png',
  'src/assets/tile_082.png',
  'src/assets/tile_083.png',
  'src/assets/tile_084.png',
  'src/assets/tile_085.png',
  'src/assets/tile_086.png',
  'src/assets/tile_087.png',
  'src/assets/tile_088.png',
  'src/assets/tile_089.png',
  'src/assets/tile_090.png',
  'src/assets/tile_091.png',
  'src/assets/tile_092.png',
  'src/assets/tile_093.png',
  'src/assets/tile_094.png',
  'src/assets/tile_095.png',
  'src/assets/tile_096.png',
  'src/assets/tile_097.png',
  'src/assets/tile_098.png',
  'src/assets/tile_099.png',
  'src/assets/tile_100.png',
  'src/assets/tile_101.png',
  'src/assets/tile_102.png',
  'src/assets/tile_103.png',
  'src/assets/tile_104.png',
  'src/assets/tile_105.png',
  'src/assets/tile_106.png',
  'src/assets/tile_107.png',
  'src/assets/tile_108.png',
  'src/assets/tile_109.png',
  'src/assets/tile_110.png',
  'src/assets/tile_111.png',
  'src/assets/tile_112.png',
  'src/assets/tile_113.png',
  'src/assets/tile_114.png',
  // Dungeon tileset - directional variants
  'src/assets/barrel_E.png',
  'src/assets/barrel_N.png',
  'src/assets/barrel_S.png',
  'src/assets/barrel_W.png',
  'src/assets/barrels_E.png',
  'src/assets/barrels_N.png',
  'src/assets/barrels_S.png',
  'src/assets/barrels_W.png',
  'src/assets/barrelsStacked_E.png',
  'src/assets/barrelsStacked_N.png',
  'src/assets/barrelsStacked_S.png',
  'src/assets/barrelsStacked_W.png',
  'src/assets/bridge_E.png',
  'src/assets/bridge_N.png',
  'src/assets/bridge_S.png',
  'src/assets/bridge_W.png',
  'src/assets/bridgeBroken_E.png',
  'src/assets/bridgeBroken_N.png',
  'src/assets/bridgeBroken_S.png',
  'src/assets/bridgeBroken_W.png',
  'src/assets/chair_E.png',
  'src/assets/chair_N.png',
  'src/assets/chair_S.png',
  'src/assets/chair_W.png',
  'src/assets/chestClosed_E.png',
  'src/assets/chestClosed_N.png',
  'src/assets/chestClosed_S.png',
  'src/assets/chestClosed_W.png',
  'src/assets/chestOpen_E.png',
  'src/assets/chestOpen_N.png',
  'src/assets/chestOpen_S.png',
  'src/assets/chestOpen_W.png',
  'src/assets/dirt_E.png',
  'src/assets/dirt_N.png',
  'src/assets/dirt_S.png',
  'src/assets/dirt_W.png',
  'src/assets/dirtTiles_E.png',
  'src/assets/dirtTiles_N.png',
  'src/assets/dirtTiles_S.png',
  'src/assets/dirtTiles_W.png',
  'src/assets/planks_E.png',
  'src/assets/planks_N.png',
  'src/assets/planks_S.png',
  'src/assets/planks_W.png',
  'src/assets/planksBroken_E.png',
  'src/assets/planksBroken_N.png',
  'src/assets/planksBroken_S.png',
  'src/assets/planksBroken_W.png',
  'src/assets/planksHole_E.png',
  'src/assets/planksHole_N.png',
  'src/assets/planksHole_S.png',
  'src/assets/planksHole_W.png',
  'src/assets/stairs_E.png',
  'src/assets/stairs_N.png',
  'src/assets/stairs_S.png',
  'src/assets/stairs_W.png',
  'src/assets/stairsAged_E.png',
  'src/assets/stairsAged_N.png',
  'src/assets/stairsAged_S.png',
  'src/assets/stairsAged_W.png',
  'src/assets/stairsCorner_E.png',
  'src/assets/stairsCorner_N.png',
  'src/assets/stairsCorner_S.png',
  'src/assets/stairsCorner_W.png',
  'src/assets/stairsSpiral_E.png',
  'src/assets/stairsSpiral_N.png',
  'src/assets/stairsSpiral_S.png',
  'src/assets/stairsSpiral_W.png',
  'src/assets/stone_E.png',
  'src/assets/stone_N.png',
  'src/assets/stone_S.png',
  'src/assets/stone_W.png',
  'src/assets/stoneColumn_E.png',
  'src/assets/stoneColumn_N.png',
  'src/assets/stoneColumn_S.png',
  'src/assets/stoneColumn_W.png',
  'src/assets/stoneColumnWood_E.png',
  'src/assets/stoneColumnWood_N.png',
  'src/assets/stoneColumnWood_S.png',
  'src/assets/stoneColumnWood_W.png',
  'src/assets/stoneCorner_E.png',
  'src/assets/stoneCorner_N.png',
  'src/assets/stoneCorner_S.png',
  'src/assets/stoneCorner_W.png',
  'src/assets/stoneInset_E.png',
  'src/assets/stoneInset_N.png',
  'src/assets/stoneInset_S.png',
  'src/assets/stoneInset_W.png',
  'src/assets/stoneLeft_E.png',
  'src/assets/stoneLeft_N.png',
  'src/assets/stoneLeft_S.png',
  'src/assets/stoneLeft_W.png',
  'src/assets/stoneMissingTiles_E.png',
  'src/assets/stoneMissingTiles_N.png',
  'src/assets/stoneMissingTiles_S.png',
  'src/assets/stoneMissingTiles_W.png',
  'src/assets/stoneRight_E.png',
  'src/assets/stoneRight_N.png',
  'src/assets/stoneRight_S.png',
  'src/assets/stoneRight_W.png',
  'src/assets/stoneSide_E.png',
  'src/assets/stoneSide_N.png',
  'src/assets/stoneSide_S.png',
  'src/assets/stoneSide_W.png',
  'src/assets/stoneSideUneven_E.png',
  'src/assets/stoneSideUneven_N.png',
  'src/assets/stoneSideUneven_S.png',
  'src/assets/stoneSideUneven_W.png',
  'src/assets/stoneStep_E.png',
  'src/assets/stoneStep_N.png',
  'src/assets/stoneStep_S.png',
  'src/assets/stoneStep_W.png',
  'src/assets/stoneSteps_E.png',
  'src/assets/stoneSteps_N.png',
  'src/assets/stoneSteps_S.png',
  'src/assets/stoneSteps_W.png',
  'src/assets/stoneTile_E.png',
  'src/assets/stoneTile_N.png',
  'src/assets/stoneTile_S.png',
  'src/assets/stoneTile_W.png',
  'src/assets/stoneUneven_E.png',
  'src/assets/stoneUneven_N.png',
  'src/assets/stoneUneven_S.png',
  'src/assets/stoneUneven_W.png',
  'src/assets/stoneWall_E.png',
  'src/assets/stoneWall_N.png',
  'src/assets/stoneWall_S.png',
  'src/assets/stoneWall_W.png',
  'src/assets/stoneWallAged_E.png',
  'src/assets/stoneWallAged_N.png',
  'src/assets/stoneWallAged_S.png',
  'src/assets/stoneWallAged_W.png',
  'src/assets/stoneWallAgedLeft_E.png',
  'src/assets/stoneWallAgedLeft_N.png',
  'src/assets/stoneWallAgedLeft_S.png',
  'src/assets/stoneWallAgedLeft_W.png',
  'src/assets/stoneWallAgedRight_E.png',
  'src/assets/stoneWallAgedRight_N.png',
  'src/assets/stoneWallAgedRight_S.png',
  'src/assets/stoneWallAgedRight_W.png',
  'src/assets/stoneWallArchway_E.png',
  'src/assets/stoneWallArchway_N.png',
  'src/assets/stoneWallArchway_S.png',
  'src/assets/stoneWallArchway_W.png',
  'src/assets/stoneWallBroken_E.png',
  'src/assets/stoneWallBroken_N.png',
  'src/assets/stoneWallBroken_S.png',
  'src/assets/stoneWallBroken_W.png',
  'src/assets/stoneWallBrokenLeft_E.png',
  'src/assets/stoneWallBrokenLeft_N.png',
  'src/assets/stoneWallBrokenLeft_S.png',
  'src/assets/stoneWallBrokenLeft_W.png',
  'src/assets/stoneWallBrokenRight_E.png',
  'src/assets/stoneWallBrokenRight_N.png',
  'src/assets/stoneWallBrokenRight_S.png',
  'src/assets/stoneWallBrokenRight_W.png',
  'src/assets/stoneWallColumn_E.png',
  'src/assets/stoneWallColumn_N.png',
  'src/assets/stoneWallColumn_S.png',
  'src/assets/stoneWallColumn_W.png',
  'src/assets/stoneWallColumnIn_E.png',
  'src/assets/stoneWallColumnIn_N.png',
  'src/assets/stoneWallColumnIn_S.png',
  'src/assets/stoneWallColumnIn_W.png',
  'src/assets/stoneWallCorner_E.png',
  'src/assets/stoneWallCorner_N.png',
  'src/assets/stoneWallCorner_S.png',
  'src/assets/stoneWallCorner_W.png',
  'src/assets/stoneWallDoor_E.png',
  'src/assets/stoneWallDoor_N.png',
  'src/assets/stoneWallDoor_S.png',
  'src/assets/stoneWallDoor_W.png',
  'src/assets/stoneWallDoorBars_E.png',
  'src/assets/stoneWallDoorBars_N.png',
  'src/assets/stoneWallDoorBars_S.png',
  'src/assets/stoneWallDoorBars_W.png',
  'src/assets/stoneWallDoorClosed_E.png',
  'src/assets/stoneWallDoorClosed_N.png',
  'src/assets/stoneWallDoorClosed_S.png',
  'src/assets/stoneWallDoorClosed_W.png',
  'src/assets/stoneWallDoorOpen_E.png',
  'src/assets/stoneWallDoorOpen_N.png',
  'src/assets/stoneWallDoorOpen_S.png',
  'src/assets/stoneWallDoorOpen_W.png',
  'src/assets/stoneWallGate_E.png',
  'src/assets/stoneWallGate_N.png',
  'src/assets/stoneWallGate_S.png',
  'src/assets/stoneWallGate_W.png',
  'src/assets/stoneWallGateBars_E.png',
  'src/assets/stoneWallGateBars_N.png',
  'src/assets/stoneWallGateBars_S.png',
  'src/assets/stoneWallGateBars_W.png',
  'src/assets/stoneWallGateClosed_E.png',
  'src/assets/stoneWallGateClosed_N.png',
  'src/assets/stoneWallGateClosed_S.png',
  'src/assets/stoneWallGateClosed_W.png',
  'src/assets/stoneWallGateOpen_E.png',
  'src/assets/stoneWallGateOpen_N.png',
  'src/assets/stoneWallGateOpen_S.png',
  'src/assets/stoneWallGateOpen_W.png',
  'src/assets/stoneWallHalf_E.png',
  'src/assets/stoneWallHalf_N.png',
  'src/assets/stoneWallHalf_S.png',
  'src/assets/stoneWallHalf_W.png',
  'src/assets/stoneWallHole_E.png',
  'src/assets/stoneWallHole_N.png',
  'src/assets/stoneWallHole_S.png',
  'src/assets/stoneWallHole_W.png',
  'src/assets/stoneWallRound_E.png',
  'src/assets/stoneWallRound_N.png',
  'src/assets/stoneWallRound_S.png',
  'src/assets/stoneWallRound_W.png',
  'src/assets/stoneWallRoundBroken_E.png',
  'src/assets/stoneWallRoundBroken_N.png',
  'src/assets/stoneWallRoundBroken_S.png',
  'src/assets/stoneWallRoundBroken_W.png',
  'src/assets/stoneWallRoundWindow_E.png',
  'src/assets/stoneWallRoundWindow_N.png',
  'src/assets/stoneWallRoundWindow_S.png',
  'src/assets/stoneWallRoundWindow_W.png',
  'src/assets/stoneWallStructure_E.png',
  'src/assets/stoneWallStructure_N.png',
  'src/assets/stoneWallStructure_S.png',
  'src/assets/stoneWallStructure_W.png',
  'src/assets/stoneWallTop_E.png',
  'src/assets/stoneWallTop_N.png',
  'src/assets/stoneWallTop_S.png',
  'src/assets/stoneWallTop_W.png',
  'src/assets/stoneWallWindow_E.png',
  'src/assets/stoneWallWindow_N.png',
  'src/assets/stoneWallWindow_S.png',
  'src/assets/stoneWallWindow_W.png',
  'src/assets/stoneWallWindowBars_E.png',
  'src/assets/stoneWallWindowBars_N.png',
  'src/assets/stoneWallWindowBars_S.png',
  'src/assets/stoneWallWindowBars_W.png',
  'src/assets/tableChairsBroken_E.png',
  'src/assets/tableChairsBroken_N.png',
  'src/assets/tableChairsBroken_S.png',
  'src/assets/tableChairsBroken_W.png',
  'src/assets/tableRound_E.png',
  'src/assets/tableRound_N.png',
  'src/assets/tableRound_S.png',
  'src/assets/tableRound_W.png',
  'src/assets/tableRoundChairs_E.png',
  'src/assets/tableRoundChairs_N.png',
  'src/assets/tableRoundChairs_S.png',
  'src/assets/tableRoundChairs_W.png',
  'src/assets/tableRoundItemsChairs_E.png',
  'src/assets/tableRoundItemsChairs_N.png',
  'src/assets/tableRoundItemsChairs_S.png',
  'src/assets/tableRoundItemsChairs_W.png',
  'src/assets/tableShort_E.png',
  'src/assets/tableShort_N.png',
  'src/assets/tableShort_S.png',
  'src/assets/tableShort_W.png',
  'src/assets/tableShortChairs_E.png',
  'src/assets/tableShortChairs_N.png',
  'src/assets/tableShortChairs_S.png',
  'src/assets/tableShortChairs_W.png',
  'src/assets/woodenCrate_E.png',
  'src/assets/woodenCrate_N.png',
  'src/assets/woodenCrate_S.png',
  'src/assets/woodenCrate_W.png',
  'src/assets/woodenCrates_E.png',
  'src/assets/woodenCrates_N.png',
  'src/assets/woodenCrates_S.png',
  'src/assets/woodenCrates_W.png',
  'src/assets/woodenPile_E.png',
  'src/assets/woodenPile_N.png',
  'src/assets/woodenPile_S.png',
  'src/assets/woodenPile_W.png',
  'src/assets/woodenSupportBeams_E.png',
  'src/assets/woodenSupportBeams_N.png',
  'src/assets/woodenSupportBeams_S.png',
  'src/assets/woodenSupportBeams_W.png',
  'src/assets/woodenSupports_E.png',
  'src/assets/woodenSupports_N.png',
  'src/assets/woodenSupports_S.png',
  'src/assets/woodenSupports_W.png',
  'src/assets/woodenSupportsBeam_E.png',
  'src/assets/woodenSupportsBeam_N.png',
  'src/assets/woodenSupportsBeam_S.png',
  'src/assets/woodenSupportsBeam_W.png',
  'src/assets/woodenSupportsBlock_E.png',
  'src/assets/woodenSupportsBlock_N.png',
  'src/assets/woodenSupportsBlock_S.png',
  'src/assets/woodenSupportsBlock_W.png',
];

function initAssetPickers() {
  const pickers = document.querySelectorAll('.asset-picker');

  pickers.forEach(picker => {
    const input = picker.querySelector('input[type="text"]');
    const toggle = picker.querySelector('.picker-toggle');
    const grid = picker.querySelector('.asset-grid');
    const preview = picker.querySelector('.selected-preview');

    // Populate grid with assets
    TILE_ASSETS.forEach(asset => {
      const item = document.createElement('div');
      item.className = 'asset-item';
      item.innerHTML = `<img src="${asset}" alt="${asset.split('/').pop()}" title="${asset.split('/').pop()}">`;
      item.addEventListener('click', () => {
        input.value = asset;
        updatePreview(preview, asset);
        grid.classList.remove('show');
        refreshMazeTileset(); // Live update
      });
      grid.appendChild(item);
    });

    // Toggle grid visibility
    toggle.addEventListener('click', (e) => {
      e.preventDefault();
      grid.classList.toggle('show');
    });

    // Update preview on input change
    input.addEventListener('input', () => {
      updatePreview(preview, input.value);
    });

    // Live update on blur (after typing a URL)
    input.addEventListener('change', () => {
      refreshMazeTileset();
    });

    // Close grid when clicking outside
    document.addEventListener('click', (e) => {
      if (!picker.contains(e.target)) {
        grid.classList.remove('show');
      }
    });

    // Add clear button functionality
    const clearBtn = picker.querySelector('.clear-btn');
    if (clearBtn) {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        input.value = '';
        updatePreview(preview, '');
        refreshMazeTileset(); // Live update
      });
    }
  });
}

function updatePreview(previewEl, src) {
  if (src && src.trim()) {
    previewEl.innerHTML = `<img src="${src}" alt="Preview">`;
    previewEl.classList.add('has-image');
  } else {
    previewEl.innerHTML = '';
    previewEl.classList.remove('has-image');
  }
}

// Refresh the maze display with new tileset without regenerating paths
function refreshMazeTileset() {
  if (typeof mazeNodes === 'undefined' || !mazeNodes.matrix || !mazeNodes.matrix.length) {
    return; // No maze generated yet
  }

  // Build tileset from current input values
  const tileWallLeft = document.getElementById('tile-wall-left');
  const tileWallRight = document.getElementById('tile-wall-right');
  const tilePathway = document.getElementById('tile-pathway');
  // Directional start tiles
  const tileStartN = document.getElementById('tile-start-n');
  const tileStartS = document.getElementById('tile-start-s');
  const tileStartE = document.getElementById('tile-start-e');
  const tileStartW = document.getElementById('tile-start-w');
  // Directional end tiles
  const tileEndN = document.getElementById('tile-end-n');
  const tileEndS = document.getElementById('tile-end-s');
  const tileEndE = document.getElementById('tile-end-e');
  const tileEndW = document.getElementById('tile-end-w');
  const showStrokeCheckbox = document.getElementById('show-stroke');

  const wallLeftUrl = tileWallLeft ? tileWallLeft.value.trim() : '';
  const wallRightUrl = tileWallRight ? tileWallRight.value.trim() : '';
  const pathwayUrl = tilePathway ? tilePathway.value.trim() : '';
  // Directional start URLs
  const startNUrl = tileStartN ? tileStartN.value.trim() : '';
  const startSUrl = tileStartS ? tileStartS.value.trim() : '';
  const startEUrl = tileStartE ? tileStartE.value.trim() : '';
  const startWUrl = tileStartW ? tileStartW.value.trim() : '';
  // Directional end URLs
  const endNUrl = tileEndN ? tileEndN.value.trim() : '';
  const endSUrl = tileEndS ? tileEndS.value.trim() : '';
  const endEUrl = tileEndE ? tileEndE.value.trim() : '';
  const endWUrl = tileEndW ? tileEndW.value.trim() : '';

  // Update tileset on existing maze
  let tileset = null;
  const hasAnyTile = wallLeftUrl || wallRightUrl || pathwayUrl ||
    startNUrl || startSUrl || startEUrl || startWUrl ||
    endNUrl || endSUrl || endEUrl || endWUrl;

  if (hasAnyTile) {
    tileset = {};
    if (wallLeftUrl) tileset.wallLeft = wallLeftUrl;
    if (wallRightUrl) tileset.wallRight = wallRightUrl;
    if (pathwayUrl) tileset.pathway = pathwayUrl;
    // Directional start tiles
    if (startNUrl) tileset.startN = startNUrl;
    if (startSUrl) tileset.startS = startSUrl;
    if (startEUrl) tileset.startE = startEUrl;
    if (startWUrl) tileset.startW = startWUrl;
    // Directional end tiles
    if (endNUrl) tileset.endN = endNUrl;
    if (endSUrl) tileset.endS = endSUrl;
    if (endEUrl) tileset.endE = endEUrl;
    if (endWUrl) tileset.endW = endWUrl;
  }

  const wallHeightInput = document.getElementById('wall-height');
  const strokeWidthInput = document.getElementById('stroke-width');
  const wallBgColorInput = document.getElementById('wall-bg-color');
  const strokeTopCheckbox = document.getElementById('stroke-top');
  const strokeBottomCheckbox = document.getElementById('stroke-bottom');
  const strokeCornersCheckbox = document.getElementById('stroke-corners');
  const strokeWallCornersCheckbox = document.getElementById('stroke-wall-corners');
  const debugStrokeColorsCheckbox = document.getElementById('debug-stroke-colors');
  const debugTestPatternCheckbox = document.getElementById('debug-test-pattern');
  const tightSpacingCheckbox = document.getElementById('tight-spacing');
  const isoRatioSelect = document.getElementById('iso-ratio');

  mazeNodes.tileset = tileset;
  mazeNodes.tileImages = {}; // Clear cached images
  mazeNodes.showStroke = showStrokeCheckbox ? showStrokeCheckbox.checked : true;
  mazeNodes.strokeTop = strokeTopCheckbox ? strokeTopCheckbox.checked : true;
  mazeNodes.strokeBottom = strokeBottomCheckbox ? strokeBottomCheckbox.checked : true;
  mazeNodes.strokeCorners = strokeCornersCheckbox ? strokeCornersCheckbox.checked : true;
  mazeNodes.strokeWallCorners = strokeWallCornersCheckbox ? strokeWallCornersCheckbox.checked : false;
  mazeNodes.debugStrokeColors = debugStrokeColorsCheckbox ? debugStrokeColorsCheckbox.checked : false;
  mazeNodes.debugTestPattern = debugTestPatternCheckbox ? debugTestPatternCheckbox.checked : false;
  mazeNodes.tightSpacing = tightSpacingCheckbox ? tightSpacingCheckbox.checked : false;
  mazeNodes.wallHeight = wallHeightInput ? parseFloat(wallHeightInput.value) || 1.0 : 1.0;
  mazeNodes.strokeWidth = strokeWidthInput ? parseFloat(strokeWidthInput.value) || 2 : 2;
  mazeNodes.wallBgColor = wallBgColorInput ? wallBgColorInput.value.trim() : '';
  mazeNodes.isoRatio = isoRatioSelect ? parseFloat(isoRatioSelect.value) || 0.5 : 0.5;

  // Reload tileset and redraw
  mazeNodes.loadTileset().then(function() {
    mazeNodes.draw();
  });
}

// Initialize stroke toggle listeners
function initStrokeToggle() {
  const strokeCheckboxes = [
    'show-stroke',
    'stroke-top',
    'stroke-bottom',
    'stroke-corners',
    'stroke-wall-corners',
    'debug-stroke-colors',
    'tight-spacing'
  ];
  strokeCheckboxes.forEach(id => {
    const checkbox = document.getElementById(id);
    if (checkbox) {
      checkbox.addEventListener('change', refreshMazeTileset);
    }
  });
}

// Initialize wall background color listener
function initWallBgColor() {
  const wallBgColorInput = document.getElementById('wall-bg-color');
  if (wallBgColorInput) {
    wallBgColorInput.addEventListener('change', function() {
      // Update color sample preview
      const colorSample = wallBgColorInput.parentNode.querySelector('.color-sample');
      if (colorSample) {
        colorSample.style.backgroundColor = wallBgColorInput.value.trim() || 'transparent';
      }
      refreshMazeTileset();
    });
  }
}

// Initialize isometric ratio listener
function initIsoRatio() {
  const isoRatioSelect = document.getElementById('iso-ratio');
  if (isoRatioSelect) {
    isoRatioSelect.addEventListener('change', refreshMazeTileset);
  }
}

// Initialize previews for inputs with existing values
function initPreviews() {
  const pickers = document.querySelectorAll('.asset-picker');
  pickers.forEach(picker => {
    const input = picker.querySelector('input[type="text"]');
    const preview = picker.querySelector('.selected-preview');
    if (input && preview && input.value.trim()) {
      updatePreview(preview, input.value.trim());
    }
  });
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
  initAssetPickers();
  initStrokeToggle();
  initWallBgColor();
  initIsoRatio();
  initPreviews();
});
