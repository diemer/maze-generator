// Asset list for tile picker
const TILE_ASSETS = [
  'src/assets/isobricks.png',
  'src/assets/isobricks2.png',
  'src/assets/isobricks3.png',
  'src/assets/isobricks4.png',
  'src/assets/isobrickswall.png',
  'src/assets/isobrickswall2.png',
  'src/assets/isobrickswall3.png',
  'src/assets/isobrickswall4.png',
  'src/assets/isocube.png',
  'src/assets/Isowoodtexture.png',
  'src/assets/Isowoodtexture2.png',
  'src/assets/isorock.png',
  'src/assets/isorock2.png',
  'src/assets/IsoPillar.png',
  'src/assets/IsoPillar2.png',
  'src/assets/isosquare-pillar1.png',
  'src/assets/ISOARCH.png',
  'src/assets/ISOARCH2.png',
  'src/assets/ISOARCHporticullis.png',
  'src/assets/isoDoorWood1.png',
  'src/assets/isoDoorWood2.png',
  'src/assets/isowindow.png',
  'src/assets/isowindow2.png',
  'src/assets/isostair.png',
  'src/assets/isostair2.png',
  'src/assets/isostair3.png',
  'src/assets/isostair4.png',
  'src/assets/isoslope.png',
  'src/assets/isoslope2.png',
  'src/assets/isoslopeback.png',
  'src/assets/isoslopeback2.png',
  'src/assets/isoladder.png',
  'src/assets/isoladder2.png',
  'src/assets/Iso-Pit.png',
  'src/assets/isotree.png',
  'src/assets/isobush.png',
  'src/assets/isowalltorch.png',
  'src/assets/isowalltorch2.png',
  'src/assets/isocandle.png',
  'src/assets/isocandlelit.png',
  'src/assets/isobanner.png',
  'src/assets/isobanner2.png',
  'src/assets/IsoTableRound.png',
  'src/assets/IsoTableSquare.png',
  'src/assets/IsoChair1.png',
  'src/assets/IsoChair2.png',
  'src/assets/IsoChair3.png',
  'src/assets/IsoChair4.png',
  'src/assets/isobed.png',
  'src/assets/isobed2.png',
  'src/assets/isobed3.png',
  'src/assets/isobed4.png',
  'src/assets/isobookcase.png',
  'src/assets/isobookcase2.png',
  'src/assets/isobookcase-back.png',
  'src/assets/isobookcase-back2.png',
  'src/assets/isoempty-bookcase.png',
  'src/assets/isoempty-bookcase2.png',
  'src/assets/isobook.png',
  'src/assets/IsoBarrel.png',
  'src/assets/isoChest.png',
  'src/assets/isoChest2.png',
  'src/assets/isocrate.png',
  'src/assets/isogold.png',
  'src/assets/isoRug.png',
  'src/assets/isoRug2.png',
  'src/assets/isobones.png',
  'src/assets/isobones2.png',
  'src/assets/isolever.png',
  'src/assets/isolever2.png',
  // Tileset tiles
  'src/assets/tile_000.png',
  'src/assets/tile_001.png',
  'src/assets/tile_002.png',
  'src/assets/tile_003.png',
  'src/assets/tile_004.png',
  'src/assets/tile_005.png',
  'src/assets/tile_006.png',
  'src/assets/tile_007.png',
  'src/assets/tile_008.png',
  'src/assets/tile_009.png',
  'src/assets/tile_010.png',
  'src/assets/tile_011.png',
  'src/assets/tile_012.png',
  'src/assets/tile_013.png',
  'src/assets/tile_014.png',
  'src/assets/tile_015.png',
  'src/assets/tile_016.png',
  'src/assets/tile_017.png',
  'src/assets/tile_018.png',
  'src/assets/tile_019.png',
  'src/assets/tile_020.png',
  'src/assets/tile_021.png',
  'src/assets/tile_022.png',
  'src/assets/tile_023.png',
  'src/assets/tile_024.png',
  'src/assets/tile_025.png',
  'src/assets/tile_026.png',
  'src/assets/tile_027.png',
  'src/assets/tile_028.png',
  'src/assets/tile_029.png',
  'src/assets/tile_030.png',
  'src/assets/tile_031.png',
  'src/assets/tile_032.png',
  'src/assets/tile_033.png',
  'src/assets/tile_034.png',
  'src/assets/tile_035.png',
  'src/assets/tile_036.png',
  'src/assets/tile_037.png',
  'src/assets/tile_038.png',
  'src/assets/tile_039.png',
  'src/assets/tile_040.png',
  'src/assets/tile_041.png',
  'src/assets/tile_042.png',
  'src/assets/tile_043.png',
  'src/assets/tile_044.png',
  'src/assets/tile_045.png',
  'src/assets/tile_046.png',
  'src/assets/tile_047.png',
  'src/assets/tile_048.png',
  'src/assets/tile_049.png',
  'src/assets/tile_050.png',
  'src/assets/tile_051.png',
  'src/assets/tile_052.png',
  'src/assets/tile_053.png',
  'src/assets/tile_054.png',
  'src/assets/tile_055.png',
  'src/assets/tile_056.png',
  'src/assets/tile_057.png',
  'src/assets/tile_058.png',
  'src/assets/tile_059.png',
  'src/assets/tile_060.png',
  'src/assets/tile_061.png',
  'src/assets/tile_062.png',
  'src/assets/tile_063.png',
  'src/assets/tile_064.png',
  'src/assets/tile_065.png',
  'src/assets/tile_066.png',
  'src/assets/tile_067.png',
  'src/assets/tile_068.png',
  'src/assets/tile_069.png',
  'src/assets/tile_070.png',
  'src/assets/tile_071.png',
  'src/assets/tile_072.png',
  'src/assets/tile_073.png',
  'src/assets/tile_074.png',
  'src/assets/tile_075.png',
  'src/assets/tile_076.png',
  'src/assets/tile_077.png',
  'src/assets/tile_078.png',
  'src/assets/tile_079.png',
  'src/assets/tile_080.png',
  'src/assets/tile_081.png',
  'src/assets/tile_082.png',
  'src/assets/tile_083.png',
  'src/assets/tile_084.png',
  'src/assets/tile_085.png',
  'src/assets/tile_086.png',
  'src/assets/tile_087.png',
  'src/assets/tile_088.png',
  'src/assets/tile_089.png',
  'src/assets/tile_090.png',
  'src/assets/tile_091.png',
  'src/assets/tile_092.png',
  'src/assets/tile_093.png',
  'src/assets/tile_094.png',
  'src/assets/tile_095.png',
  'src/assets/tile_096.png',
  'src/assets/tile_097.png',
  'src/assets/tile_098.png',
  'src/assets/tile_099.png',
  'src/assets/tile_100.png',
  'src/assets/tile_101.png',
  'src/assets/tile_102.png',
  'src/assets/tile_103.png',
  'src/assets/tile_104.png',
  'src/assets/tile_105.png',
  'src/assets/tile_106.png',
  'src/assets/tile_107.png',
  'src/assets/tile_108.png',
  'src/assets/tile_109.png',
  'src/assets/tile_110.png',
  'src/assets/tile_111.png',
  'src/assets/tile_112.png',
  'src/assets/tile_113.png',
  'src/assets/tile_114.png',
];

function initAssetPickers() {
  const pickers = document.querySelectorAll('.asset-picker');

  pickers.forEach(picker => {
    const input = picker.querySelector('input[type="text"]');
    const toggle = picker.querySelector('.picker-toggle');
    const grid = picker.querySelector('.asset-grid');
    const preview = picker.querySelector('.selected-preview');

    // Populate grid with assets
    TILE_ASSETS.forEach(asset => {
      const item = document.createElement('div');
      item.className = 'asset-item';
      item.innerHTML = `<img src="${asset}" alt="${asset.split('/').pop()}" title="${asset.split('/').pop()}">`;
      item.addEventListener('click', () => {
        input.value = asset;
        updatePreview(preview, asset);
        grid.classList.remove('show');
        refreshMazeTileset(); // Live update
      });
      grid.appendChild(item);
    });

    // Toggle grid visibility
    toggle.addEventListener('click', (e) => {
      e.preventDefault();
      grid.classList.toggle('show');
    });

    // Update preview on input change
    input.addEventListener('input', () => {
      updatePreview(preview, input.value);
    });

    // Live update on blur (after typing a URL)
    input.addEventListener('change', () => {
      refreshMazeTileset();
    });

    // Close grid when clicking outside
    document.addEventListener('click', (e) => {
      if (!picker.contains(e.target)) {
        grid.classList.remove('show');
      }
    });

    // Add clear button functionality
    const clearBtn = picker.querySelector('.clear-btn');
    if (clearBtn) {
      clearBtn.addEventListener('click', (e) => {
        e.preventDefault();
        input.value = '';
        updatePreview(preview, '');
        refreshMazeTileset(); // Live update
      });
    }
  });
}

function updatePreview(previewEl, src) {
  if (src && src.trim()) {
    previewEl.innerHTML = `<img src="${src}" alt="Preview">`;
    previewEl.classList.add('has-image');
  } else {
    previewEl.innerHTML = '';
    previewEl.classList.remove('has-image');
  }
}

// Refresh the maze display with new tileset without regenerating paths
function refreshMazeTileset() {
  if (typeof mazeNodes === 'undefined' || !mazeNodes.matrix || !mazeNodes.matrix.length) {
    return; // No maze generated yet
  }

  // Build tileset from current input values
  const tileWallLeft = document.getElementById('tile-wall-left');
  const tileWallRight = document.getElementById('tile-wall-right');
  const tilePathway = document.getElementById('tile-pathway');
  const tileStart = document.getElementById('tile-start');
  const tileEnd = document.getElementById('tile-end');
  const showStrokeCheckbox = document.getElementById('show-stroke');

  const wallLeftUrl = tileWallLeft ? tileWallLeft.value.trim() : '';
  const wallRightUrl = tileWallRight ? tileWallRight.value.trim() : '';
  const pathwayUrl = tilePathway ? tilePathway.value.trim() : '';
  const startUrl = tileStart ? tileStart.value.trim() : '';
  const endUrl = tileEnd ? tileEnd.value.trim() : '';

  // Update tileset on existing maze
  let tileset = null;
  if (wallLeftUrl || wallRightUrl || pathwayUrl || startUrl || endUrl) {
    tileset = {};
    if (wallLeftUrl) tileset.wallLeft = wallLeftUrl;
    if (wallRightUrl) tileset.wallRight = wallRightUrl;
    if (pathwayUrl) tileset.pathway = pathwayUrl;
    if (startUrl) tileset.start = startUrl;
    if (endUrl) tileset.end = endUrl;
  }

  const wallHeightInput = document.getElementById('wall-height');
  const strokeWidthInput = document.getElementById('stroke-width');
  const wallBgColorInput = document.getElementById('wall-bg-color');
  const strokeTopCheckbox = document.getElementById('stroke-top');
  const strokeBottomCheckbox = document.getElementById('stroke-bottom');
  const strokeCornersCheckbox = document.getElementById('stroke-corners');
  const strokeWallCornersCheckbox = document.getElementById('stroke-wall-corners');
  const debugStrokeColorsCheckbox = document.getElementById('debug-stroke-colors');
  const debugTestPatternCheckbox = document.getElementById('debug-test-pattern');
  const isoRatioSelect = document.getElementById('iso-ratio');

  mazeNodes.tileset = tileset;
  mazeNodes.tileImages = {}; // Clear cached images
  mazeNodes.showStroke = showStrokeCheckbox ? showStrokeCheckbox.checked : true;
  mazeNodes.strokeTop = strokeTopCheckbox ? strokeTopCheckbox.checked : true;
  mazeNodes.strokeBottom = strokeBottomCheckbox ? strokeBottomCheckbox.checked : true;
  mazeNodes.strokeCorners = strokeCornersCheckbox ? strokeCornersCheckbox.checked : true;
  mazeNodes.strokeWallCorners = strokeWallCornersCheckbox ? strokeWallCornersCheckbox.checked : false;
  mazeNodes.debugStrokeColors = debugStrokeColorsCheckbox ? debugStrokeColorsCheckbox.checked : false;
  mazeNodes.debugTestPattern = debugTestPatternCheckbox ? debugTestPatternCheckbox.checked : false;
  mazeNodes.wallHeight = wallHeightInput ? parseFloat(wallHeightInput.value) || 1.0 : 1.0;
  mazeNodes.strokeWidth = strokeWidthInput ? parseFloat(strokeWidthInput.value) || 2 : 2;
  mazeNodes.wallBgColor = wallBgColorInput ? wallBgColorInput.value.trim() : '';
  mazeNodes.isoRatio = isoRatioSelect ? parseFloat(isoRatioSelect.value) || 0.5 : 0.5;

  // Reload tileset and redraw
  mazeNodes.loadTileset().then(function() {
    mazeNodes.draw();
  });
}

// Initialize stroke toggle listeners
function initStrokeToggle() {
  const strokeCheckboxes = [
    'show-stroke',
    'stroke-top',
    'stroke-bottom',
    'stroke-corners',
    'stroke-wall-corners',
    'debug-stroke-colors'
  ];
  strokeCheckboxes.forEach(id => {
    const checkbox = document.getElementById(id);
    if (checkbox) {
      checkbox.addEventListener('change', refreshMazeTileset);
    }
  });
}

// Initialize wall background color listener
function initWallBgColor() {
  const wallBgColorInput = document.getElementById('wall-bg-color');
  if (wallBgColorInput) {
    wallBgColorInput.addEventListener('change', function() {
      // Update color sample preview
      const colorSample = wallBgColorInput.parentNode.querySelector('.color-sample');
      if (colorSample) {
        colorSample.style.backgroundColor = wallBgColorInput.value.trim() || 'transparent';
      }
      refreshMazeTileset();
    });
  }
}

// Initialize isometric ratio listener
function initIsoRatio() {
  const isoRatioSelect = document.getElementById('iso-ratio');
  if (isoRatioSelect) {
    isoRatioSelect.addEventListener('change', refreshMazeTileset);
  }
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
  initAssetPickers();
  initStrokeToggle();
  initWallBgColor();
  initIsoRatio();
});
